<html>

<head>
  <title>Pigar</title>
  <script src='./vendor/sqljs-wasm/sql-wasm.js'></script>
  <script src='./vendor/pako/pako_inflate.min.js'></script>
  <script type="module">
    document.getElementById("query").disabled = true;
    const queryPlaceholder = document.getElementById("query").placeholder;
    document.getElementById("query").placeholder = "loading database...";
    const sqlPromise = initSqlJs({
      locateFile: file => `./vendor/sqljs-wasm/${file}`
    });

    // GitHub pages is not sending gziped content, so..
    const dataPromise = fetch("./static/pigar.sqlite3.bin.gz").then(function (res) {
      return res.arrayBuffer();
    }).then(function (buffer) {
      return pako.inflate(buffer);
    });
    const [SQL, buf] = await Promise.all([sqlPromise, dataPromise]);
    document.getElementById("query").disabled = false;
    document.getElementById("query").placeholder = queryPlaceholder;

    const db = new SQL.Database(new Uint8Array(buf));

    function search() {
      const query = document.getElementById('query').value.trim();
      if (query.length === 0) {
        return;
      }
      const contents = db.exec(`SELECT name, version FROM distributions WHERE id IN
        (SELECT distribution_id FROM top_level_module_names WHERE name="${query}")`);

      const results = document.getElementById("results");
      results.innerHTML = '';
      const table = document.createElement('table');
      table.setAttribute("border", "1");
      if (contents.length > 0) {
        const rows = contents[0]["values"].sort((a, b) => (a[1] > b[1]) ? 1 : -1);
        table.innerHTML = '<thead><tr> <th>Distribution</th> <th>URL</th> </tr></thead><tbody>';
        rows.forEach(function (row) {
          let name = row[0];
          const version = row[1];
          const url = `https://pypi.org/project/${name}/`;
          if (name === query || name.toLowerCase() == query.toLowerCase()) { // Diff algorithm such as edit distance is not a good fit..
            name = `<span style="font-weight: 900">${name}</span>`;
          } else if (name.includes(query)) {
            name = `<span style="font-weight: 500">${name}</span>`;
          }
          table.innerHTML += `<tr> <td>${name}</td> <td><a href="${url}" target="_blank">${url}</a></td> </tr>`;
        })
        table.innerHTML += `</tbody>`;
      }
      results.appendChild(table);
    }
    document.getElementById("search").addEventListener("click", search);
    document.addEventListener("keypress", function (event) {
      if (event.key === 'Enter') {
        search();
      }
    });
  </script>
  <style type="text/css">
    td {
      padding: 0 15px;
    }
  </style>
</head>

<body>
  <h2>What is Pigar</h2>
  <ul dir="auto">
    <li>Generating requirements.txt for Python project.
      <ul dir="auto">
        <li>Handling the difference between different Python versions.</li>
        <li>Jupyter notebook (<code>*.ipynb</code>) support.</li>
        <li>Including the import statements/magic from <code>exec</code>/<code>eval</code>/<code>importlib</code>, doctest of docstring, etc.</li>
      </ul>
    </li>
    <li>Searching ditributions(packages) by the top level import/module names.</li>
    <li>Checking the latest versions of requirements.</li>
  </ul>
  Further information can be found <a href="https://github.com/damnever/pigar">here</a>.
  <hr />
  <h2>Search Python Packages/Distributions by the Top-level Import/Module Name</h2>
  <p>Powered by <a href="https://github.com/sql-js/sql.js">sql.js</a> and <a href="https://github.com/damnever/pigar/blob/main/pigar/.db.sqlite3">the pigar index database</a>.</p>
  <div>
    <input name="query" type="text" placeholder="e.g. requests" size="50" id="query" />
    <button id="search">Search</button>
  </div>
  <br />
  <div id="results"></div>
</body>

</html>
